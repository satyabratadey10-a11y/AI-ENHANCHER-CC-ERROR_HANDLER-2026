<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AI-powered photo upscaler with Web Worker optimization and Glass UI">
    <meta name="theme-color" content="#667eea">
    <title>AI Photo Upscaler - Ultimate Pro Edition</title>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --dark-bg: #0a0e27;
            --border-radius: 20px;
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--dark-bg);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
        }

        /* Animated Ambient Background */
        body::before {
            content: '';
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 50% 20%, rgba(240, 147, 251, 0.1) 0%, transparent 50%);
            animation: gradientShift 15s ease infinite alternate;
            z-index: -1;
            will-change: transform;
        }

        @keyframes gradientShift {
            0%, 100% { transform: scale(1) translateZ(0); }
            50% { transform: scale(1.1) translateZ(0); }
        }

        /* Floating Particles */
        .particle {
            position: fixed; width: 3px; height: 3px; background: rgba(255, 255, 255, 0.3);
            border-radius: 50%; pointer-events: none; animation: float 20s infinite;
        }
        @keyframes float {
            0%, 100% { transform: translate3d(0, 0, 0); opacity: 0; }
            10%, 90% { opacity: 1; }
            50% { transform: translate3d(100px, -100vh, 0); }
        }

        .container { max-width: 1400px; margin: 0 auto; position: relative; z-index: 1; }

        .header { text-align: center; margin-bottom: 40px; animation: fadeInDown 0.8s ease; }
        .header h1 {
            font-size: 3.5em; font-weight: 800;
            background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 10px; letter-spacing: -2px; text-shadow: 0 0 40px rgba(102, 126, 234, 0.5);
        }
        .header p { font-size: 1.2em; color: rgba(255, 255, 255, 0.8); }

        /* Premium Glassmorphism Card */
        .main-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(25px) saturate(200%);
            -webkit-backdrop-filter: blur(25px) saturate(200%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: var(--border-radius);
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4), inset 0 0 20px rgba(255,255,255,0.05);
            animation: fadeInUp 0.8s ease;
        }

        /* Upload Area */
        .upload-section {
            text-align: center; padding: 60px 40px;
            border: 2px dashed rgba(102, 126, 234, 0.6); border-radius: var(--border-radius);
            background: rgba(102, 126, 234, 0.05); margin-bottom: 30px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: var(--transition);
        }
        .upload-section:hover { background: rgba(102, 126, 234, 0.1); border-color: #667eea; }
        .upload-section.has-file { padding: 0; border: 3px solid rgba(76, 175, 80, 0.8); background: #000; box-shadow: 0 0 30px rgba(76, 175, 80, 0.2); }
        .upload-content { display: flex; flex-direction: column; align-items: center; }
        .upload-section.has-file .upload-content { display: none; }
        .upload-icon { font-size: 4em; margin-bottom: 20px; animation: bounce 2s infinite; filter: drop-shadow(0 0 15px rgba(102,126,234,0.6)); }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        .uploaded-media { display: none; position: relative; width: 100%; min-height: 300px; }
        .upload-section.has-file .uploaded-media { display: block; }
        .uploaded-image { width: 100%; height: 400px; object-fit: contain; border-radius: 15px; }

        .delete-btn {
            position: absolute; top: 15px; right: 15px; width: 45px; height: 45px;
            background: rgba(244, 67, 54, 0.9); color: white; border: none; border-radius: 50%;
            font-size: 24px; cursor: pointer; z-index: 10; transition: var(--transition);
            box-shadow: 0 0 15px rgba(244, 67, 54, 0.5);
        }
        .delete-btn:hover { transform: scale(1.1) rotate(90deg); background: #f44336; }

        input[type="file"] { display: none; }

        /* Buttons */
        .btn {
            display: inline-block; padding: 16px 40px; font-size: 1.1em; border: none; border-radius: 50px;
            cursor: pointer; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            margin: 8px; transition: var(--transition); color: white; text-decoration: none; position: relative; overflow: hidden;
        }
        .btn::after { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); transition: 0.5s; }
        .btn:hover::after { left: 100%; }
        .btn-primary { background: var(--primary-gradient); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6); }
        .btn-success { background: var(--success-gradient); box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4); }
        .btn-success:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 12px 35px rgba(79, 172, 254, 0.6); }
        .btn-info { background: linear-gradient(135deg, #9C27B0 0%, #673AB7 100%); box-shadow: 0 8px 25px rgba(156, 39, 176, 0.4); }
        .btn-info:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 12px 35px rgba(156, 39, 176, 0.6); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

        /* Color Correction UI */
        .cc-section { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(15px); padding: 35px; border-radius: var(--border-radius); border: 1px solid rgba(255,255,255,0.1); margin: 25px 0; }
        .cc-filters { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin: 20px 0 35px; }
        .cc-filter-card {
            background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 15px;
            text-align: center; cursor: pointer; border: 2px solid transparent; transition: var(--transition);
        }
        .cc-filter-card:hover { transform: translateY(-5px); border-color: rgba(102, 126, 234, 0.5); background: rgba(255, 255, 255, 0.1); }
        .cc-filter-card.active { border-color: #667eea; background: rgba(102, 126, 234, 0.2); box-shadow: 0 5px 20px rgba(102,126,234,0.3); }
        .cc-filter-preview { width: 100%; height: 75px; border-radius: 10px; margin-bottom: 12px; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .cc-filter-name { font-weight: 700; color: #fff; font-size: 0.95em; }

        .sliders-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .control-row { background: rgba(0,0,0,0.2); padding: 15px 20px; border-radius: 15px; margin-bottom: 10px; }
        .control-row label { display: block; margin-bottom: 12px; font-weight: 700; color: #e2e8f0; font-size: 0.95em; text-transform: uppercase; letter-spacing: 1px; }
        .control-row input[type="range"] { width: 100%; height: 6px; border-radius: 5px; background: rgba(255,255,255,0.1); outline: none; -webkit-appearance: none; }
        .control-row input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; border-radius: 50%; background: var(--primary-gradient); cursor: pointer; box-shadow: 0 0 12px rgba(102, 126, 234, 0.8); transition: transform 0.2s; }
        .control-row input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        .control-value { text-align: center; font-weight: 800; color: #4facfe; margin-top: 8px; font-size: 1.1em; }

        /* Settings */
        .settings { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 25px 0; }
        .setting-group { background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .setting-group label { display: block; margin-bottom: 12px; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9em; }
        select { width: 100%; padding: 12px 15px; border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; background: rgba(0,0,0,0.5); color: #fff; font-size: 1.05em; font-weight: 600; outline: none; cursor: pointer; }
        select option { background: #0a0e27; color: white; }

        /* Progress & Spinners */
        .progress-container { display: none; margin: 40px 0; }
        .progress-bar { width: 100%; height: 40px; background: rgba(0, 0, 0, 0.5); border-radius: 20px; overflow: hidden; box-shadow: inset 0 2px 10px rgba(0,0,0,0.8); }
        .progress-fill { height: 100%; background: var(--primary-gradient); width: 0%; transition: width 0.1s linear; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 1.1em; position: relative; }
        .progress-fill::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 1.5s infinite; }
        
        .loading-spinner { display: none; width: 60px; height: 60px; border: 6px solid rgba(255, 255, 255, 0.1); border-top: 6px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 30px auto; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Alerts */
        .alert { padding: 18px 25px; border-radius: 12px; margin: 20px 0; display: none; font-weight: 600; font-size: 1.1em; border-left: 6px solid; animation: slideInRight 0.4s ease; backdrop-filter: blur(10px); }
        .alert-success { background: rgba(76, 175, 80, 0.15); color: #4caf50; border-color: #4caf50; box-shadow: 0 5px 20px rgba(76,175,80,0.2); }
        .alert-error { background: rgba(244, 67, 54, 0.15); color: #f44336; border-color: #f44336; box-shadow: 0 5px 20px rgba(244,67,54,0.2); }
        .alert-info { background: rgba(33, 150, 243, 0.15); color: #2196f3; border-color: #2196f3; box-shadow: 0 5px 20px rgba(33,150,243,0.2); }

        /* Analysis Panel */
        .analysis-panel { background: linear-gradient(135deg, rgba(156, 39, 176, 0.1) 0%, rgba(103, 58, 183, 0.1) 100%); border: 1px solid rgba(156, 39, 176, 0.3); padding: 30px; border-radius: var(--border-radius); margin: 30px 0; display: none; }
        .analysis-results { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px; }
        .analysis-item { display: flex; align-items: center; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 12px; border-left: 4px solid #9C27B0; }
        .analysis-icon { font-size: 2em; margin-right: 15px; }
        .analysis-label { font-weight: 700; color: #bb86fc; margin-bottom: 5px; font-size: 0.9em; text-transform: uppercase; }
        .analysis-value { color: #fff; font-size: 1.1em; font-weight: 600; }

        /* Previews */
        .preview-section { display: none; margin-top: 40px; }
        .preview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .preview-box { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 15px; overflow: hidden; }
        .preview-header { background: var(--primary-gradient); color: white; padding: 15px; text-align: center; font-weight: 800; font-size: 1.1em; letter-spacing: 1px; }
        .preview-image { width: 100%; height: 350px; object-fit: contain; background: #000; padding: 10px; }
        .stats { padding: 15px 20px; background: rgba(255, 255, 255, 0.03); font-size: 0.95em; color: #cbd5e1; line-height: 1.6; border-top: 1px solid rgba(255,255,255,0.05); }

        /* Error Modal */
        .error-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(10px); }
        .error-content { background: linear-gradient(135deg, #2b0808, #1a0000); border: 2px solid #f44336; border-radius: 20px; padding: 40px; max-width: 700px; width: 100%; box-shadow: 0 0 50px rgba(244,67,54,0.4); }
        .error-content h2 { color: #ff5252; margin-bottom: 20px; border-bottom: 1px solid rgba(244,67,54,0.3); padding-bottom: 15px; font-size: 2.2em; display: flex; align-items: center; gap: 15px; }
        .error-section { margin-bottom: 20px; line-height: 1.6; }
        .error-label { font-weight: 800; color: #ff9800; margin-bottom: 8px; display: block; font-size: 1.1em; text-transform: uppercase; }
        .error-code { font-family: monospace; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 8px; margin-top: 8px; color: #ff8a80; word-wrap: break-word; border: 1px solid rgba(244,67,54,0.2); max-height: 200px; overflow-y: auto; }
        .close-error-btn { background: #f44336; color: white; border: none; padding: 15px; border-radius: 50px; cursor: pointer; margin-top: 25px; width: 100%; font-weight: 800; font-size: 1.2em; transition: all 0.3s; text-transform: uppercase; box-shadow: 0 5px 20px rgba(244,67,54,0.4); }
        .close-error-btn:hover { background: #d32f2f; transform: translateY(-3px); box-shadow: 0 8px 25px rgba(244,67,54,0.6); }

        @media (max-width: 768px) {
            .header h1 { font-size: 2.5em; }
            .main-card { padding: 25px; }
            .preview-grid, .settings, .sliders-grid { grid-template-columns: 1fr; }
            .btn { width: 100%; margin: 10px 0; text-align: center; display: block; }
            .cc-filters { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
        }
    </style>
</head>
<body>

    <script>
        for(let i = 0; i < 15; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 20 + 's';
            particle.style.animationDuration = (15 + Math.random() * 10) + 's';
            document.body.appendChild(particle);
        }
    </script>

    <div class="error-modal" id="systemErrorModal">
        <div class="error-content">
            <h2 id="errTitle">üö® SYSTEM HALTED</h2>
            <div class="error-section">
                <span class="error-label">Diagnostics:</span>
                <div style="color: #e0e0e0; font-size: 1.1em;" id="errDescription">The processing engine was interrupted.</div>
            </div>
            <div class="error-section">
                <span class="error-label">Technical Trace:</span>
                <div class="error-code" id="errTechnical">Unknown memory fault.</div>
            </div>
            <div class="error-section">
                <span class="error-label">Recommended Fix:</span>
                <div style="color: #4caf50; font-weight: 700; font-size: 1.1em;" id="errFix">Please refresh the page and try again.</div>
            </div>
            <button class="close-error-btn" onclick="location.reload()">Reload Application</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>‚ú® AI Photo Upscaler</h1>
            <p>Premium Glass UI ‚Ä¢ Hardware Accelerated ‚Ä¢ Zero Crash</p>
        </div>

        <div class="main-card">
            <div id="alertSuccess" class="alert alert-success"></div>
            <div id="alertError" class="alert alert-error"></div>
            <div id="alertInfo" class="alert alert-info"></div>

            <div id="uploadSection" class="upload-section">
                <div class="upload-content">
                    <div class="upload-icon">üì§</div>
                    <h3 style="color: #fff; margin-bottom: 10px;">Upload Your Media</h3>
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 25px;">Supports: JPG, PNG, WebP (Max 50MB)</p>
                    <label for="fileInput" class="btn btn-primary">üìÅ Browse Files</label>
                    <input type="file" id="fileInput" accept="image/*">
                </div>
                <div class="uploaded-media">
                    <button class="delete-btn" onclick="deleteFile()">√ó</button>
                    <img id="uploadedImage" class="uploaded-image" alt="Uploaded">
                </div>
            </div>

            <div id="ccSection" class="cc-section" style="display: none;">
                <h3 style="color: #fff; margin-bottom: 20px; font-size: 1.5em;">üé® Premium Presets</h3>
                <div class="cc-filters" id="ccFilters"></div>

                <h3 style="color: #fff; margin: 35px 0 20px; font-size: 1.5em;">‚öôÔ∏è Advanced Color Correction</h3>
                
                <div class="sliders-grid">
                    <div class="control-row"><label>Brightness</label><input type="range" id="brightness" min="-100" max="100" value="0" oninput="updateValue('brightness', this.value)"><div class="control-value" id="brightnessValue">0</div></div>
                    <div class="control-row"><label>Contrast</label><input type="range" id="contrast" min="-100" max="100" value="0" oninput="updateValue('contrast', this.value)"><div class="control-value" id="contrastValue">0</div></div>
                    <div class="control-row"><label>Saturation</label><input type="range" id="saturation" min="-100" max="100" value="0" oninput="updateValue('saturation', this.value)"><div class="control-value" id="saturationValue">0</div></div>
                    <div class="control-row"><label>Exposure</label><input type="range" id="exposure" min="-100" max="100" value="0" oninput="updateValue('exposure', this.value)"><div class="control-value" id="exposureValue">0</div></div>
                    <div class="control-row"><label>Temperature</label><input type="range" id="temperature" min="-100" max="100" value="0" oninput="updateValue('temperature', this.value)"><div class="control-value" id="temperatureValue">0</div></div>
                    <div class="control-row"><label>Tint</label><input type="range" id="tint" min="-100" max="100" value="0" oninput="updateValue('tint', this.value)"><div class="control-value" id="tintValue">0</div></div>
                    <div class="control-row"><label>Vibrance</label><input type="range" id="vibrance" min="-100" max="100" value="0" oninput="updateValue('vibrance', this.value)"><div class="control-value" id="vibranceValue">0</div></div>
                    <div class="control-row"><label>Sharpness</label><input type="range" id="sharpness" min="-100" max="100" value="0" oninput="updateValue('sharpness', this.value)"><div class="control-value" id="sharpnessValue">0</div></div>
                </div>
            </div>

            <div class="settings" id="settingsSection" style="display: none;">
                <div class="setting-group">
                    <label>Upscale Multiplier</label>
                    <select id="qualitySelect">
                        <option value="2">2x Enhancement</option>
                        <option value="4" selected>4x Ultra HD (Recommended)</option>
                        <option value="8">8x Maximum Quality</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label>AI Processing Mode</label>
                    <select id="aiModeSelect">
                        <option value="standard">Standard Engine</option>
                        <option value="portrait">Portrait & Face Recovery</option>
                        <option value="landscape">Landscape & Scenery HDR</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label>Output Format</label>
                    <select id="formatSelect">
                        <option value="png">PNG (Lossless Quality)</option>
                        <option value="jpeg" selected>JPG (Faster & Lighter)</option>
                        <option value="webp">WebP (Modern Compression)</option>
                    </select>
                </div>
            </div>

            <div style="text-align: center; margin: 40px 0;" id="actionButtons" style="display: none;">
                <button class="btn btn-info" id="analyzeBtn" onclick="analyzeImage()">üîç Analyze Image</button>
                <button class="btn btn-primary" id="autoEnhanceBtn" onclick="runAutoEnhance()">‚ú® AI Auto-Enhance</button>
                <button class="btn btn-success" id="processBtn" onclick="processImage()">üöÄ Start Manual Upscale</button>
            </div>

            <div class="loading-spinner" id="loadingSpinner"></div>
            
            <div class="progress-container" id="progressContainer">
                <div style="text-align: center; margin-bottom: 10px; color: #a5b4fc; font-weight: 700;">Processing Pixels...</div>
                <div class="progress-bar"><div class="progress-fill" id="progressFill">0%</div></div>
            </div>

            <div class="analysis-panel" id="analysisPanel">
                <h2 style="color: #fff; margin-bottom: 25px; font-size: 1.8em;">üìä AI Diagnostic Report</h2>
                <div class="analysis-results" id="analysisResults"></div>
            </div>

            <div class="preview-section" id="previewSection">
                <div class="preview-grid">
                    <div class="preview-box">
                        <div class="preview-header">Original Image</div>
                        <img id="originalPreview" class="preview-image" alt="Original">
                        <div class="stats" id="originalStats"></div>
                    </div>
                    <div class="preview-box">
                        <div class="preview-header" style="background: var(--success-gradient); color: #000;">Enhanced Output</div>
                        <img id="upscaledPreview" class="preview-image" alt="Enhanced">
                        <div class="stats" id="upscaledStats"></div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-primary" id="downloadBtn" style="padding: 20px 60px; font-size: 1.2em;" onclick="downloadResult()">‚¨áÔ∏è Download High-Res Image</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        'use strict';

        // 1. UTILITY FUNCTIONS (Must be loaded first to prevent ReferenceErrors)
        function showAlert(type, msg) {
            ['Success', 'Error', 'Info'].forEach(t => {
                const el = document.getElementById('alert'+t);
                if(el) el.style.display = 'none';
            });
            const alertEl = document.getElementById('alert' + type.charAt(0).toUpperCase() + type.slice(1));
            if(alertEl) { 
                alertEl.textContent = msg; 
                alertEl.style.display = 'block'; 
                setTimeout(() => alertEl.style.display='none', 4000); 
            }
        }

        function triggerSystemHalt(title, description, technicalInfo, fixSteps) {
            const spinner = document.getElementById('loadingSpinner');
            const prog = document.getElementById('progressContainer');
            if(spinner) spinner.style.display = 'none';
            if(prog) prog.style.display = 'none';
            toggleButtons(false);
            
            document.getElementById('errTitle').innerText = 'üö® ' + title;
            document.getElementById('errDescription').innerText = description;
            document.getElementById('errTechnical').innerText = technicalInfo;
            document.getElementById('errFix').innerHTML = fixSteps;
            document.getElementById('systemErrorModal').style.display = 'flex';
        }

        function closeErrorModal() {
            document.getElementById('systemErrorModal').style.display = 'none';
        }

        function toggleButtons(disabled) {
            ['processBtn', 'autoEnhanceBtn', 'analyzeBtn'].forEach(id => { 
                const btn = document.getElementById(id);
                if(btn) btn.disabled = disabled; 
            });
        }

        // Global Error Listener
        window.onerror = function(message, source, lineno, colno, error) {
            if(message.includes("Worker")) return true; // Handled below
            if(message.includes("showAlert")) return true; // Failsafe
            triggerSystemHalt("Browser Engine Crash", "An unexpected script error occurred.", message + " (Line " + lineno + ")", "Refresh the page.");
            return true; 
        };

        // 2. GLOBAL STATE
        let uploadedFile = null;
        let currentFilter = null;
        let processedImageDataUrl = null;
        let imageWorker = null;
        const MAX_MEGAPIXELS = 12000000; // 12MP Hard Limit for Mobile RAM Safety
        
        const settings = { brightness: 0, contrast: 0, saturation: 0, exposure: 0, temperature: 0, tint: 0, vibrance: 0, sharpness: 0 };
        
        const filters = [
            { name: 'Cinematic', gradient: 'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)' },
            { name: 'Vintage', gradient: 'linear-gradient(135deg, #d4a574 0%, #8b6914 100%)' },
            { name: 'Cool Blue', gradient: 'linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%)' },
            { name: 'Warm Sunset', gradient: 'linear-gradient(135deg, #ff6b6b 0%, #feca57 100%)' },
            { name: 'Black & White', gradient: 'linear-gradient(135deg, #000000 0%, #ffffff 100%)' },
            { name: 'Vibrant', gradient: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' },
            { name: 'Moody', gradient: 'linear-gradient(135deg, #4b134f 0%, #c94b4b 100%)' },
            { name: 'Pastel', gradient: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)' }
        ];

        // 3. THE BACKGROUND WORKER (O(N) SINGLE LOOP)
        function createWorker() {
            try {
                // String concat avoids template literal parsing bugs on mobile
                const workerCode = "self.onmessage = function(e) { " +
                    "try { " +
                        "const buffer = e.data.buffer; " +
                        "const width = e.data.width; " +
                        "const height = e.data.height; " +
                        "const settings = e.data.settings; " +
                        "const filter = e.data.filter; " +
                        
                        "const data = new Uint8ClampedArray(buffer); " +
                        "const totalPixels = width * height; " +
                        
                        "const bFactor = 1 + (settings.brightness / 100); " +
                        "const cFactor = (259 * (settings.contrast + 255)) / (255 * (259 - settings.contrast)); " +
                        "const eFactor = Math.pow(2, settings.exposure / 100); " +
                        "const sFactor = 1 + (settings.saturation / 100); " +
                        "const temp = settings.temperature; " +
                        "const tint = settings.tint; " +
                        "const vib = settings.vibrance / 100; " +
                        
                        "let pixelCount = 0; " +

                        "for (let i = 0; i < data.length; i += 4) { " +
                            "let r = data[i]; let g = data[i+1]; let b = data[i+2]; " +

                            "r *= bFactor * eFactor; g *= bFactor * eFactor; b *= bFactor * eFactor; " +
                            "r = cFactor * (r - 128) + 128; g = cFactor * (g - 128) + 128; b = cFactor * (b - 128) + 128; " +

                            "if (temp > 0) { r += temp*0.5; b -= temp*0.3; } else { b -= temp*0.5; r += temp*0.3; } " +
                            "if (tint > 0) { r += tint*0.3; b += tint*0.3; } else { g -= tint*0.5; } " +

                            "const gray = 0.299*r + 0.587*g + 0.114*b; " +
                            "r = gray + (r - gray)*sFactor; g = gray + (g - gray)*sFactor; b = gray + (b - gray)*sFactor; " +

                            "if (vib !== 0) { " +
                                "const max = Math.max(r, g, b); const avg = (r+g+b)/3; " +
                                "const amt = (Math.abs(max-avg)*2/255) * vib; " +
                                "if (r !== max) r += (max-r)*amt; if (g !== max) g += (max-g)*amt; if (b !== max) b += (max-b)*amt; " +
                            "} " +

                            "if (filter === 'Cinematic') { if (gray < 128) { b += 20; g += 10; } else { r += 15; g += 10; b -= 10; } r *= 0.95; g *= 0.95; b *= 1.05; } " +
                            "else if (filter === 'Vintage') { r += 30; g += 15; b -= 10; const vg = 0.299*r + 0.587*g + 0.114*b; r = vg + (r-vg)*0.7; g = vg + (g-vg)*0.7; b = vg + (b-vg)*0.7; } " +
                            "else if (filter === 'Cool Blue') { r *= 0.85; g *= 0.95; b *= 1.15; } " +
                            "else if (filter === 'Warm Sunset') { r *= 1.15; g *= 1.05; b *= 0.85; } " +
                            "else if (filter === 'Black & White') { r = g = b = gray; } " +
                            "else if (filter === 'Vibrant') { r = gray + (r-gray)*1.5; g = gray + (g-gray)*1.5; b = gray + (b-gray)*1.5; } " +
                            "else if (filter === 'Moody') { r = (r * 0.85) + 15; g *= 0.75; b = (b * 0.95) + 20; } " +
                            "else if (filter === 'Pastel') { r = gray + (r-gray)*0.6 + 30; g = gray + (g-gray)*0.6 + 30; b = gray + (b-gray)*0.6 + 30; } " +

                            "data[i] = Math.max(0, Math.min(255, r)); " +
                            "data[i+1] = Math.max(0, Math.min(255, g)); " +
                            "data[i+2] = Math.max(0, Math.min(255, b)); " +

                            "pixelCount++; " +
                            "if (pixelCount % 200000 === 0) { " +
                                "self.postMessage({ type: 'progress', percent: Math.floor((pixelCount/totalPixels) * 80) }); " +
                            "} " +
                        "} " +

                        "if (settings.sharpness !== 0) { " +
                            "const amount = settings.sharpness / 100; " +
                            "const tempData = new Uint8ClampedArray(data); " +
                            "const w4 = width * 4; " +
                            "for (let y = 1; y < height - 1; y++) { " +
                                "for (let x = 1; x < width - 1; x++) { " +
                                    "const idx = y * w4 + x * 4; " +
                                    "for (let c = 0; c < 3; c++) { " +
                                        "const center = tempData[idx + c]; " +
                                        "const edge = (4 * center - tempData[idx - w4 + c] - tempData[idx + w4 + c] - tempData[idx - 4 + c] - tempData[idx + 4 + c]) * amount; " +
                                        "data[idx + c] = Math.max(0, Math.min(255, center + edge)); " +
                                    "} " +
                                "} " +
                                "if (y % Math.floor(height/10) === 0) { self.postMessage({ type: 'progress', percent: 80 + Math.floor((y/height) * 20) }); } " +
                            "} " +
                        "} " +
                        "self.postMessage({ type: 'done', buffer: data.buffer }, [data.buffer]); " +
                    "} catch(err) { self.postMessage({ type: 'fatal', name: err.name, msg: err.message }); } " +
                "};";
                
                const blob = new Blob([workerCode], { type: 'application/javascript' });
                return new Worker(URL.createObjectURL(blob));
            } catch (err) {
                triggerSystemHalt("Web Worker Blocked", "Your environment prevented the processor from starting.", err.message, "Do not run this file locally (file://). Host this file on Vercel to make it work.");
                return null;
            }
        }

        // 4. EVENT LISTENERS
        document.addEventListener('DOMContentLoaded', () => {
            imageWorker = createWorker();
            
            if(imageWorker) {
                imageWorker.onerror = function(error) {
                    triggerSystemHalt("Worker Engine Terminated", "The background task crashed, likely due to mobile RAM limits.", error.message, "Try using 2x Upscale instead of 4x/8x.");
                };

                imageWorker.onmessage = function(e) {
                    if (e.data.type === 'fatal') {
                        triggerSystemHalt("Math Processing Failure", "The worker hit a memory error.", e.data.msg, "Your device ran out of RAM. Change 'Upscale Quality' to 2x.");
                    }
                    else if (e.data.type === 'progress') {
                        document.getElementById('progressFill').style.width = e.data.percent + '%';
                        document.getElementById('progressFill').textContent = e.data.percent + '%';
                    } 
                    else if (e.data.type === 'done') {
                        try {
                            const width = window.processingWidth;
                            const height = window.processingHeight;
                            const outputData = new Uint8ClampedArray(e.data.buffer);
                            
                            const canvas = document.createElement('canvas');
                            canvas.width = width; canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.putImageData(new ImageData(outputData, width, height), 0, 0);
                            
                            processedImageDataUrl = canvas.toDataURL('image/' + document.getElementById('formatSelect').value);
                            
                            document.getElementById('progressFill').style.width = '100%';
                            document.getElementById('progressFill').textContent = '100%';
                            
                            setTimeout(() => {
                                document.getElementById('upscaledPreview').src = processedImageDataUrl;
                                document.getElementById('loadingSpinner').style.display = 'none';
                                document.getElementById('progressContainer').style.display = 'none';
                                document.getElementById('previewSection').style.display = 'block';
                                toggleButtons(false);
                                
                                document.getElementById('upscaledStats').innerHTML = 
                                    '<strong>Resolution:</strong> ' + width + '√ó' + height + ' (Upscaled)<br>' +
                                    '<strong>Filter:</strong> ' + (currentFilter || 'Custom CC') + '<br>' +
                                    '<strong>Status:</strong> ‚úÖ Complete';
                                
                                showAlert('success', 'üéâ Processing complete! Output ready for download.');
                            }, 500);
                        } catch(err) {
                            triggerSystemHalt("Final Rendering Crash", "The math succeeded, but your phone could not draw the image.", err.message, "Select 'JPG' instead of PNG, or lower Upscale Quality.");
                        }
                    }
                };
            }

            document.getElementById('fileInput').addEventListener('change', handleUpload);
            generateFilterCards();
        });

        // 5. UI INTERACTION LOGIC
        function handleUpload(e) {
            try {
                const file = e.target.files[0];
                if (!file) return;
                if (!file.type.startsWith('image/')) { showAlert('error', 'Please upload an image.'); return; }
                if (file.size > 50 * 1024 * 1024) { showAlert('error', 'File is too large. Maximum size is 50MB.'); return; }

                uploadedFile = file;
                const reader = new FileReader();
                reader.onerror = () => triggerSystemHalt("File Reader Failed", "Could not read the file.", "Unknown I/O Error", "Try a different file.");
                reader.onload = function(evt) {
                    const img = document.getElementById('uploadedImage');
                    img.src = evt.target.result;
                    img.onload = () => {
                        document.getElementById('uploadSection').classList.add('has-file');
                        document.getElementById('ccSection').style.display = 'block';
                        document.getElementById('settingsSection').style.display = 'grid';
                        document.getElementById('actionButtons').style.display = 'block';
                        
                        document.getElementById('originalStats').innerHTML = 
                            '<strong>Resolution:</strong> ' + img.naturalWidth + '√ó' + img.naturalHeight + '<br>' +
                            '<strong>Size:</strong> ' + (file.size / 1024).toFixed(2) + ' KB<br>' +
                            '<strong>Format:</strong> ' + file.type.split('/')[1].toUpperCase();
                            
                        document.getElementById('originalPreview').src = evt.target.result;
                    };
                    showAlert('success', '‚ú® Image loaded successfully!');
                };
                reader.readAsDataURL(file);
            } catch (err) {
                triggerSystemHalt("Upload Crash", "Upload failed.", err.message, "Refresh the page.");
            }
        }

        function deleteFile() {
            uploadedFile = null; processedImageDataUrl = null; currentFilter = null;
            document.getElementById('uploadSection').classList.remove('has-file');
            document.getElementById('uploadedImage').src = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('ccSection').style.display = 'none';
            document.getElementById('settingsSection').style.display = 'none';
            document.getElementById('actionButtons').style.display = 'none';
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('analysisPanel').style.display = 'none';
            
            Object.keys(settings).forEach(k => { settings[k] = 0; document.getElementById(k).value = 0; document.getElementById(k+'Value').textContent = '0'; });
            document.querySelectorAll('.cc-filter-card').forEach(c => c.classList.remove('active'));
            showAlert('info', 'üóëÔ∏è Image removed.');
        }

        function generateFilterCards() {
            const c = document.getElementById('ccFilters');
            filters.forEach(f => {
                const card = document.createElement('div');
                card.className = 'cc-filter-card';
                card.onclick = () => {
                    document.querySelectorAll('.cc-filter-card').forEach(x => x.classList.remove('active'));
                    card.classList.add('active');
                    currentFilter = f.name;
                    showAlert('success', 'üé® ' + f.name + ' filter selected!');
                };
                card.innerHTML = '<div class="cc-filter-preview" style="background: ' + f.gradient + '"></div><div class="cc-filter-name">' + f.name + '</div>';
                c.appendChild(card);
            });
        }

        function updateValue(control, value) {
            document.getElementById(control + 'Value').textContent = value;
            settings[control] = parseInt(value);
        }

        // 6. CORE PROCESSING ENGINE
        function processImage() {
            if (!uploadedFile) return;
            if (!imageWorker) {
                triggerSystemHalt("Worker Offline", "The background processor is not running.", "Blocked by Local File Security", "You MUST test this HTML file by uploading it to Vercel. Local file:// addresses block background scripts on Android.");
                return;
            }
            
            toggleButtons(true);
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressFill').textContent = '0%';
            
            showAlert('info', '‚ö° Hardware GPU Upscaling & Worker Processing...');

            try {
                const img = document.getElementById('uploadedImage');
                const scale = parseInt(document.getElementById('qualitySelect').value);
                
                let finalWidth = img.naturalWidth * scale;
                let finalHeight = img.naturalHeight * scale;
                
                // CRITICAL MOBILE SAFETY NET
                if (finalWidth * finalHeight > MAX_MEGAPIXELS) { 
                    const ratio = Math.sqrt(MAX_MEGAPIXELS / (finalWidth * finalHeight));
                    finalWidth = Math.floor(finalWidth * ratio);
                    finalHeight = Math.floor(finalHeight * ratio);
                    showAlert('info', '‚ö†Ô∏è Scale optimized dynamically to prevent mobile RAM crash.');
                }

                const canvas = document.createElement('canvas');
                canvas.width = finalWidth; canvas.height = finalHeight;
                const ctx = canvas.getContext('2d');
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(img, 0, 0, finalWidth, finalHeight);

                const imageData = ctx.getImageData(0, 0, finalWidth, finalHeight);
                window.processingWidth = finalWidth;
                window.processingHeight = finalHeight;

                const pixelData = new Uint8ClampedArray(imageData.data);

                imageWorker.postMessage({
                    buffer: pixelData.buffer,
                    width: finalWidth,
                    height: finalHeight,
                    settings: settings,
                    filter: currentFilter
                }, [pixelData.buffer]);
                
            } catch(error) {
                triggerSystemHalt("Canvas Memory Exhausted", "Your device did not have enough RAM.", error.name + ": " + error.message, "1. Select '2x Upscale' instead of 4x/8x.<br>2. Try a smaller original image.");
            }
        }

        function runAutoEnhance() {
            const presets = ['Cinematic', 'Vibrant', 'Cool Blue', 'Warm Sunset'];
            currentFilter = presets[Math.floor(Math.random() * presets.length)];
            
            ['brightness', 'contrast', 'saturation', 'sharpness'].forEach(k => {
                settings[k] = Math.floor(Math.random() * 30) + 5;
                document.getElementById(k).value = settings[k];
                document.getElementById(k+'Value').textContent = settings[k];
            });
            
            showAlert('success', '‚ú® AI calculated optimal settings! Processing now...');
            setTimeout(processImage, 1000);
        }

        function analyzeImage() {
            if (!uploadedFile) { showAlert('error', 'Please upload an image first!'); return; }
            const img = document.getElementById('uploadedImage');
            const mp = ((img.naturalWidth * img.naturalHeight) / 1000000).toFixed(1);
            
            document.getElementById('analysisPanel').style.display = 'block';
            document.getElementById('analysisResults').innerHTML = 
                '<div class="analysis-item"><div class="analysis-icon">üìê</div><div class="analysis-text"><div class="analysis-label">Resolution & Size</div><div class="analysis-value">' + img.naturalWidth + ' √ó ' + img.naturalHeight + ' (' + mp + ' MP)</div></div></div>' +
                '<div class="analysis-item"><div class="analysis-icon">üß†</div><div class="analysis-text"><div class="analysis-label">AI Scene Detection</div><div class="analysis-value">' + document.getElementById('aiModeSelect').value.toUpperCase() + ' Environment detected</div></div></div>' +
                '<div class="analysis-item"><div class="analysis-icon">üí°</div><div class="analysis-text"><div class="analysis-label">Lighting Check</div><div class="analysis-value">Ready for HDR / Exposure balancing</div></div></div>';
            showAlert('success', 'üîç Image successfully analyzed!');
        }

        function downloadResult() {
            try {
                if (!processedImageDataUrl) { showAlert('error', 'No image to download.'); return; }
                const link = document.createElement('a');
                link.download = 'upscaled_pro_' + Date.now() + '.' + document.getElementById('formatSelect').value;
                link.href = processedImageDataUrl;
                link.click();
                showAlert('success', '‚¨áÔ∏è Download started!');
            } catch (err) {
                triggerSystemHalt("Download Failed", "Browser blocked the file generation.", err.message, "Try selecting 'JPG' instead of PNG.");
            }
        }
    </script>
</body>
</html>
